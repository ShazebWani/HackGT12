import { useState, useEffect } from 'react'
import { Stethoscope, SidebarClose, SidebarOpen, User, UserCircle, Plus } from 'lucide-react'
import { usePatient } from '../contexts/PatientContext'

const Sidebar = () => {
  const { filteredPatients, activePatient, selectPatient } = usePatient();
  
  // State for user info to avoid hydration issues
  const [userInfo, setUserInfo] = useState({ username: 'Unknown', role: 'Unknown' });
  const [isClient, setIsClient] = useState(false);
  const [isCollapsed, setIsCollapsed] = useState(false);
  const [isLogoHovered, setIsLogoHovered] = useState(false);

  // Get user info from localStorage on client side only
  useEffect(() => {
    setIsClient(true);
    
    try {
      // Load auth info
      const auth = localStorage.getItem('auth');
      if (auth) {
        const user = JSON.parse(auth);
        setUserInfo({
          username: user.username || 'Unknown',
          role: user.role || 'Unknown'
        });
      }
      
      // Load sidebar collapse state after client hydration
      const sidebarState = localStorage.getItem('sidebarCollapsed');
      if (sidebarState === 'true') {
        setIsCollapsed(true);
      }
    } catch (e) {
      console.error('Error parsing localStorage:', e);
    }
  }, []);

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric',
      year: 'numeric'
    });
  };

  const handleCreateNewPatient = () => {
    // Deselect current patient to show the search/create form
    selectPatient('');
  };

  const toggleSidebar = () => {
    const newCollapsedState = !isCollapsed;
    setIsCollapsed(newCollapsedState);
    // Persist sidebar state
    localStorage.setItem('sidebarCollapsed', newCollapsedState.toString());
  };

  return (
    <aside className={`h-full bg-accent-1 flex flex-col transition-all duration-300 z-10 ${
      isCollapsed ? 'w-12' : 'w-64'
    }`}>
      {/* Header */}
      <div className="flex items-center h-12 border-b border-white/20 px-3">
        <button
          onClick={toggleSidebar}
          className="flex items-center cursor-pointer gap-3 hover:scale-110 transition-all duration-300 text-white group min-w-0"
          onMouseEnter={() => setIsLogoHovered(true)}
          onMouseLeave={() => setIsLogoHovered(false)}
        >
          <div className="flex-shrink-0">
            {isCollapsed && isLogoHovered ? (
              <SidebarOpen className='size-6' />
            ) : (
              // <Stethoscope className="size-6" />
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 1000 1000" className='inline-block -ml-2'>
                <path style={{ fill: "#f1f9ff", stroke: "none" }} d="M271 440L273 439L274 443L273 441C271.955 444.581 273.91 447.651 275.266 451C277.7 457.009 280.05 463.085 282.695 469C293.112 492.294 302.647 516.241 311.938 540C321.664 564.869 332.628 589.213 342.551 614C352.432 638.681 362.189 663.822 378.884 684.911C398.49 709.675 424.35 726.923 454 737.079C467.53 741.713 481.705 744 496 744C512.936 744 528.607 742.607 545 738C542.837 737.324 541.268 737.613 539 738C545.847 734.582 553.739 735.047 561 731.921C579.368 724.015 594.978 712.088 608.999 698C615.794 691.173 623.538 683.132 627 674L625 675C626.206 672.588 627.27 669.089 630 671C633.119 664.637 636.661 658.468 639.565 652C641.169 648.426 642.476 643.391 645.498 640.728C649.216 637.452 656.35 636.915 661 635.653C667.782 633.811 674.695 630.612 681 627.525C705.728 615.413 725.823 595.502 738.293 571C752.187 543.701 755.202 512.621 748.499 483C743.08 459.049 731.209 437.981 713.8 420.6C698.225 405.05 676.85 391.932 655 387.74C640.66 384.989 626.72 382.763 612 384.17C567.699 388.403 528.506 415.869 509.362 456C481.197 515.041 502.832 590.594 560 623.28C569.605 628.772 580.965 634.347 592 636C588.527 644.799 582.195 652.596 576.333 660C554.648 687.392 517.302 698.809 484 692.333C481.693 691.885 479.257 692.325 477 691.667C449.206 683.56 429.461 665.21 414.667 641C410.603 634.35 406.348 626.635 404.333 619C402.816 613.249 405.883 610.136 407.667 605C410.827 595.899 414.798 586.804 418.833 578C421.524 572.13 422.975 565.731 426 560C428.05 556.115 430.831 550.299 431.667 546C432.05 544.03 431.109 542.172 432 540.333C432.437 539.431 433.659 540.761 434 541C457.14 479.03 483.788 417.916 509.565 357C516.019 341.748 522.645 326.476 528.532 311C530.332 306.269 535.483 298.271 532.781 293.144C529.829 287.545 520.179 289 515 289L471 289C464.849 289 457.922 288.302 454.005 294.105C448.635 302.062 446.466 313.953 443.406 323C437.053 341.785 429.617 360.306 422.911 379C411.289 411.4 399.241 443.647 387.456 476C383.095 487.971 377.296 499.676 374 512C365.777 496.398 361.167 478.44 354.831 462C339.223 421.503 325.394 380.174 309 340C307.7 340.65 308 340.147 308 342C306.47 329.128 300.357 317.307 296.204 305C294.499 299.947 293.031 293.202 287.945 290.457C284.104 288.384 279.205 289 275 289L250 289C240.751 289 231.218 288.333 222 289.093C218.549 289.378 213.963 290.422 212.644 294.108C211.265 297.958 214.168 302.51 215.471 306C218.872 315.112 222.9 324.029 226.667 333C236.291 355.916 245.845 378.919 255.078 402C260.072 414.485 264.411 428.298 271 440z"/>
                <path style={{ fill: "#095d7e", stroke: "none" }} d="M285 291C286.248 291.685 286.548 291.749 288 292C286.752 291.315 286.452 291.251 285 291M215 292L216 293L215 292M293.333 301.667C293.278 301.722 293.222 302.778 293.667 302.333C293.722 302.278 293.778 301.222 293.333 301.667M530 301L529 305C530.146 303.36 530.393 302.924 530 301M528.333 306.667C528.278 306.722 528.222 307.778 528.667 307.333C528.722 307.278 528.778 306.222 528.333 306.667M218.333 308.667C218.278 308.722 218.222 309.778 218.667 309.333C218.722 309.278 218.778 308.222 218.333 308.667M525.333 313.667C525.278 313.722 525.222 314.778 525.667 314.333C525.722 314.278 525.778 313.222 525.333 313.667M221.333 315.667C221.278 315.722 221.222 316.778 221.667 316.333C221.722 316.278 221.778 315.222 221.333 315.667M304.333 331.667C304.278 331.722 304.222 332.778 304.667 332.333C304.722 332.278 304.778 331.222 304.333 331.667M439.333 337.667C439.278 337.722 439.222 338.778 439.667 338.333C439.722 338.278 439.778 337.222 439.333 337.667M515.333 337.667C515.278 337.722 515.222 338.778 515.667 338.333C515.722 338.278 515.778 337.222 515.333 337.667M510.333 349.667C510.278 349.722 510.222 350.778 510.667 350.333C510.722 350.278 510.778 349.222 510.333 349.667M431.333 359.667C431.278 359.722 431.222 360.778 431.667 360.333C431.722 360.278 431.778 359.222 431.333 359.667M500 373L498 380C499.836 377.692 500.797 375.889 500 373M422.333 384.667C422.278 384.722 422.222 385.778 422.667 385.333C422.722 385.278 422.778 384.222 422.333 384.667M614 385C618.974 387.087 625.638 386 631 386C626.026 383.913 619.362 385 614 385M606 386C607.769 386.779 609.036 386.912 611 387C609.231 386.221 607.964 386.088 606 386M637 386C638.769 386.779 640.036 386.912 642 387C640.231 386.221 638.964 386.088 637 386M587 390C588.248 390.685 588.549 390.749 590 391C588.752 390.315 588.452 390.251 587 390M576 394C577.659 394.406 578.242 394.309 580 394C578.341 393.594 577.758 393.691 576 394M672.667 395.333C672.222 395.778 673.278 395.722 673.333 395.667C673.778 395.222 672.722 395.278 672.667 395.333M255.333 397.667C255.278 397.722 255.222 398.778 255.667 398.333C255.722 398.278 255.778 397.222 255.333 397.667M567.667 398.333C567.222 398.778 568.278 398.722 568.333 398.667C568.778 398.222 567.722 398.278 567.667 398.333M415.333 403.667C415.278 403.722 415.222 404.778 415.667 404.333C415.722 404.278 415.778 403.222 415.333 403.667M486 408C485.119 410.021 484.504 411.854 484 414C485.631 411.957 486.444 410.583 486 408M543 414L544 415L543 414M477.333 429.667C477.278 429.722 477.222 430.778 477.667 430.333C477.722 430.278 477.778 429.222 477.333 429.667M341.333 430.667C341.278 430.722 341.222 431.778 341.667 431.333C341.722 431.278 341.778 430.222 341.333 430.667M269.333 431.667C269.278 431.722 269.222 432.778 269.667 432.333C269.722 432.278 269.778 431.222 269.333 431.667M721 431L722 432L721 431M344 438L345 443C345.473 440.857 345.133 439.899 344 438M613 442C615.052 442.874 616.747 442.953 619 443C616.948 442.126 615.253 442.047 613 442M629 442C630.769 442.779 632.036 442.912 634 443C632.231 442.221 630.964 442.088 629 442M679 544L680 546C687.664 517.662 688.743 485.486 667.816 462.004C647.424 439.124 607.926 437.268 585.015 457.301C575.16 465.917 569.352 478.696 565.721 491C563.675 497.931 564 504.848 564 512C564 534.737 571.38 557.046 591 570.62C620.473 591.009 667.712 580.306 679 544M348.333 449.667C348.278 449.722 348.222 450.778 348.667 450.333C348.722 450.278 348.778 449.222 348.333 449.667M349.333 452.667C349.278 452.722 349.222 453.778 349.667 453.333C349.722 453.278 349.778 452.222 349.333 452.667M510 457L509 461C510.146 459.359 510.393 458.924 510 457M578 462L579 463L578 462M285 470L286 475C286.651 472.766 286.318 471.926 285 470M570.333 474.667C570.278 474.722 570.222 475.778 570.667 475.333C570.722 475.278 570.778 474.222 570.333 474.667M681.333 481.667C681.278 481.722 681.222 482.778 681.667 482.333C681.722 482.278 681.778 481.222 681.333 481.667M290.333 482.667C290.278 482.722 290.222 483.778 290.667 483.333C290.722 483.278 290.778 482.222 290.333 482.667M385 484L385 487C385.696 485.446 385.696 485.554 385 484M501 484L501 487C501.696 485.446 501.696 485.554 501 484M748 488L748 492C748.71 490.241 748.71 489.759 748 488M449.333 497.667C449.278 497.722 449.222 498.778 449.667 498.333C449.722 498.278 449.778 497.222 449.333 497.667M750 505L750 520C751.74 515.852 751.74 509.148 750 505M442.333 514.667C442.278 514.722 442.222 515.778 442.667 515.333C442.722 515.278 442.778 514.222 442.333 514.667M499 520L499 528C500.161 525.23 500.161 522.77 499 520M686 520L686 526C686.951 523.715 686.951 522.285 686 520M749 524L749 531C750.059 528.466 750.06 526.534 749 524M685 527L685 530C685.696 528.446 685.696 528.554 685 527M748 533L748 537C748.71 535.24 748.71 534.76 748 533M434.333 534.667C434.278 534.722 434.222 535.778 434.667 535.333C434.722 535.278 434.778 534.222 434.333 534.667M501 537L501 541C501.71 539.24 501.71 538.76 501 537M502 542L502 545C502.696 543.446 502.696 543.554 502 542M317 548L318 552C318.393 550.076 318.146 549.64 317 548M742.333 556.667C742.278 556.722 742.222 557.778 742.667 557.333C742.722 557.278 742.778 556.222 742.333 556.667M421.333 565.667C421.278 565.722 421.222 566.778 421.667 566.333C421.722 566.278 421.778 565.222 421.333 565.667M420 568L419 572C420.146 570.359 420.393 569.924 420 568M611 581C612.248 581.685 612.548 581.749 614 582C612.752 581.315 612.452 581.251 611 581M629 582C632.302 583.347 635.527 582.439 639 582C635.751 580.732 632.433 581.729 629 582M414 583L413 587C414.146 585.359 414.393 584.924 414 583M726 586C725.014 587.479 725 587.203 725 589C726.289 587.557 726.401 587.766 726 586M334.333 589.667C334.278 589.722 334.222 590.778 334.667 590.333C334.722 590.278 334.778 589.222 334.333 589.667M410.333 592.667C410.278 592.722 410.222 593.778 410.667 593.333C410.722 593.278 410.778 592.222 410.333 592.667M721 593L722 594L721 593M406 602L405 606C406.146 604.359 406.393 603.924 406 602M404 607L403 611C404.146 609.359 404.393 608.924 404 607M682.667 624.333C682.222 624.778 683.278 624.722 683.333 624.667C683.778 624.222 682.722 624.278 682.667 624.333M676.667 627.333C676.222 627.778 677.278 627.722 677.333 627.667C677.778 627.222 676.722 627.278 676.667 627.333M590 634C591.248 634.685 591.548 634.749 593 635C591.752 634.315 591.452 634.251 590 634M641.333 642.667C641.278 642.722 641.222 643.778 641.667 643.333C641.722 643.278 641.778 642.222 641.333 642.667M638 649L637 653C638.146 651.359 638.393 650.924 638 649M629.333 667.667C629.278 667.722 629.222 668.778 629.667 668.333C629.722 668.278 629.778 667.222 629.333 667.667M622 678C621.014 679.479 621 679.203 621 681C622.289 679.557 622.401 679.766 622 678M546.667 685.333C546.222 685.778 547.278 685.722 547.333 685.667C547.778 685.222 546.722 685.278 546.667 685.333M458.667 686.333C458.222 686.778 459.278 686.722 459.333 686.667C459.778 686.222 458.722 686.278 458.667 686.333M465 689C466.75 690.255 467.857 690.614 470 691C468.307 689.938 466.96 689.48 465 689M531 691C532.248 691.685 532.548 691.749 534 692C532.752 691.315 532.452 691.251 531 691M477 693C478.506 693.683 479.315 693.826 481 694C479.494 693.317 478.685 693.174 477 693M519 694C521.698 694.969 524.161 694.353 527 694C524.244 692.923 521.893 693.468 519 694M482 694C483.506 694.683 484.315 694.826 486 695C484.494 694.317 483.685 694.174 482 694M487 695C488.769 695.779 490.036 695.912 492 696C490.231 695.221 488.964 695.088 487 695M606 698L605 700C606.263 699.029 606.392 699.306 606 698M578.667 720.333C578.222 720.778 579.278 720.722 579.333 720.667C579.778 720.222 578.722 720.278 578.667 720.333M569.667 725.333C569.222 725.778 570.278 725.722 570.333 725.667C570.778 725.222 569.722 725.278 569.667 725.333M561 729C563.274 729.409 564.781 728.788 567 728C564.726 727.591 563.219 728.212 561 729M447.667 733.333C447.222 733.778 448.278 733.722 448.333 733.667C448.778 733.222 447.722 733.278 447.667 733.333M450.667 734.333C450.222 734.778 451.278 734.722 451.333 734.667C451.778 734.222 450.722 734.278 450.667 734.333M524 740C525.769 740.779 527.036 740.912 529 741C527.231 740.221 525.964 740.088 524 740z"/>
              </svg>
            )}
          </div>
          <div className={`text-white/70 text-sm whitespace-nowrap overflow-hidden ${isCollapsed ? 'hidden' : ''}`}>
            {isClient ? `${filteredPatients.length} patient${filteredPatients.length !== 1 ? 's' : ''}` : '0 patients'}
          </div>
        </button>
        {!isCollapsed && (
          <button
            onClick={toggleSidebar}
            className="ml-auto hover:scale-110 transition-transform duration-150 text-white flex-shrink-0"
          >
            <SidebarClose className='size-5' />
          </button>
        )}
      </div>

      {/* Tabs Section */}
      <div className="border-b border-white/20 px-3 py-3">
        {/* Status Tab */}
        <div className="mb-3">
          <div className="flex items-center gap-3 min-w-0 h-12">
            <div className="flex-shrink-0 flex items-center justify-center">
              <UserCircle className="h-6 w-6 text-white/80" />
            </div>
            <div className={`flex-1 min-w-0 flex flex-col justify-center ${isCollapsed ? 'hidden' : ''}`}>
              <div className="text-white/90 text-xs font-medium truncate">{isClient ? userInfo.username : 'Loading...'}</div>
              <div className="text-white/60 text-xs capitalize">{isClient ? userInfo.role : 'Unknown'}</div>
            </div>
            <div className={`w-2 h-2 rounded-full flex-shrink-0 ${isClient && userInfo.role === 'doctor' ? 'bg-green-400' : 'bg-blue-400'} ${isCollapsed ? 'hidden' : ''}`}></div>
          </div>
        </div>

        {/* Create New Patient Tab - Only show for doctors after client hydration */}
        {isClient && userInfo.role === 'doctor' && (
          <button
            onClick={handleCreateNewPatient}
            className="w-full flex items-center gap-3 cursor-pointer hover:bg-white/20 rounded-lg transition-colors duration-200 min-w-0 h-12"
            title={isCollapsed ? "Create New Patient" : undefined}
          >
            <div className="flex-shrink-0 flex items-center justify-center">
              <Plus className="h-6 w-6 text-white/80" />
            </div>
            <div className={`text-white/90 text-xs font-medium truncate flex items-center ${isCollapsed ? 'hidden' : ''}`}>
              Create New Patient
            </div>
          </button>
        )}
      </div>

      {/* Patient List - Only show when not collapsed */}
      {!isCollapsed && (
        <div className="flex-1 overflow-y-auto">
          {filteredPatients.length === 0 ? (
            <div className="p-4 text-white/70 text-sm text-center">
              No patients found
            </div>
          ) : (
            <div className="p-2">
              {filteredPatients.map((patient) => {
                const isActive = activePatient?.id === patient.id;
                
                return (
                  <button
                    key={patient.id}
                    onClick={() => selectPatient(patient.id)}
                    className={`
                      w-full text-left p-3 rounded-lg mb-2 transition-all duration-75
                      ${isActive 
                        ? 'bg-white/20' 
                        : 'hover:bg-white/10'
                      }
                    `}
                  >
                    <div className="flex items-start space-x-3">
                      <div className="mt-1">
                        <User className={`h-4 w-4 ${isActive ? 'text-white' : 'text-white/70'}`} />
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className={`font-medium text-sm truncate ${isActive ? 'text-white' : 'text-white/90'}`}>
                          {patient.firstName} {patient.lastName}
                        </div>
                        <div className={`text-xs mt-1 ${isActive ? 'text-white/80' : 'text-white/60'}`}>
                          {patient.mrn} • {formatDate(patient.dateOfBirth)}
                        </div>
                        {patient.medicalData?.chiefComplaint && (
                          <div className={`text-xs mt-1 truncate ${isActive ? 'text-white/70' : 'text-white/50'}`}>
                            {patient.medicalData.chiefComplaint}
                          </div>
                        )}
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
          )}
        </div>
      )}
    </aside>
  )
}

export default Sidebar